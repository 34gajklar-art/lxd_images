name: Build and Deploy SimpleStreams Index to Netlify

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests jinja2 pyyaml
          
      - name: Generate Ubuntu-compatible SimpleStreams
        run: |
          python3 << 'EOF'
          import requests
          import json
          import hashlib
          import os
          from datetime import datetime, timezone
          
          GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN', '')
          REPO = 'oneclickvirt/lxd_images'
          TAG = 'processed'
          BASE_URL = f'https://github.com/{REPO}/releases/download/{TAG}'
          
          headers = {}
          if GITHUB_TOKEN:
              headers['Authorization'] = f'token {GITHUB_TOKEN}'
              
          response = requests.get(f'https://api.github.com/repos/{REPO}/releases/tags/{TAG}', headers=headers)
          if response.status_code != 200:
              print(f"Error: {response.status_code}")
              exit(1)
              
          release_data = response.json()
          assets = release_data.get('assets', [])
          
          def parse_filename(filename):
              if filename.endswith('-lxd.tar.xz'):
                  base_name = filename.replace('-lxd.tar.xz', '')
              elif filename.endswith('-rootfs.squashfs'):
                  base_name = filename.replace('-rootfs.squashfs', '')
              else:
                  return None, None, None, None
              
              parts = base_name.split('-')
              if len(parts) >= 4:
                  return parts[0], parts[1], parts[2], parts[3]
              return None, None, None, None
          
          def get_placeholder_sha256():
              return hashlib.sha256(b'placeholder').hexdigest()
          
          products = {}
          redirects_rules = []
          
          lxd_files = [asset for asset in assets if asset['name'].endswith('-lxd.tar.xz')]
          rootfs_files = [asset for asset in assets if asset['name'].endswith('-rootfs.squashfs')]
          
          current_time = datetime.now(timezone.utc)
          # 使用Ubuntu兼容的版本格式：简单的日期
          version_id = current_time.strftime('%Y%m%d')
          
          print(f"Processing {len(lxd_files)} LXD files")
          print(f"Using Ubuntu-compatible version ID: {version_id}")
          
          for lxd_asset in lxd_files:
              distro, version, arch, variant = parse_filename(lxd_asset['name'])
              if not all([distro, version, arch, variant]):
                  continue
                  
              rootfs_name = lxd_asset['name'].replace('-lxd.tar.xz', '-rootfs.squashfs')
              rootfs_asset = next((a for a in rootfs_files if a['name'] == rootfs_name), None)
              
              if not rootfs_asset:
                  continue
              
              # 重定向规则
              redirects_rules.append(f'/download/{lxd_asset["name"]} {BASE_URL}/{lxd_asset["name"]} 302')
              redirects_rules.append(f'/download/{rootfs_asset["name"]} {BASE_URL}/{rootfs_asset["name"]} 302')
              
              # Ubuntu风格的产品名称：使用冒号分隔
              product_name = f'{distro}:{version}:{arch}'
              if variant != 'default':
                  product_name += f':{variant}'
              
              if product_name not in products:
                  # Ubuntu风格的别名：使用简单格式
                  aliases_list = []
                  
                  # 核心别名
                  aliases_list.append(f'{distro}/{version}')
                  
                  # 架构特定别名
                  if arch == 'amd64':  # 默认架构不显示
                      aliases_list.append(f'{distro}/{version}')
                  else:
                      aliases_list.append(f'{distro}/{version}/{arch}')
                  
                  # 变体别名
                  if variant != 'default':
                      aliases_list.append(f'{distro}/{version}/{variant}')
                      if arch != 'amd64':
                          aliases_list.append(f'{distro}/{version}/{arch}/{variant}')
                  
                  # 去重并转换为字符串
                  aliases_list = list(set(aliases_list))
                  aliases_string = ','.join(aliases_list)
                  
                  # Ubuntu兼容的产品结构
                  products[product_name] = {
                      'aliases': aliases_string,
                      'arch': arch,
                      'os': distro,
                      'release': version,
                      'release_title': f'{distro.title()} {version}',  # 添加标题
                      'support_eol': '2030-01-01',  # 添加支持日期
                      'versions': {}
                  }
                  
                  # 添加变体信息（如果不是default）
                  if variant != 'default':
                      products[product_name]['variant'] = variant
              
              # Ubuntu风格的项目结构
              version_data = {
                  'items': {
                      'lxd.tar.xz': {
                          'ftype': 'lxd.tar.xz',
                          'size': lxd_asset.get('size', 0),
                          'path': f'download/{lxd_asset["name"]}',
                          'sha256': get_placeholder_sha256()
                      },
                      'root.tar.xz': {  # Ubuntu使用root.tar.xz格式
                          'ftype': 'root.tar.xz', 
                          'size': rootfs_asset.get('size', 0),
                          'path': f'download/{rootfs_asset["name"]}',
                          'sha256': get_placeholder_sha256()
                      }
                  },
                  'label': f'{distro}-{version}',  # 添加标签
                  'pubname': f'{distro}-{version}-{arch}',  # 添加发布名称
              }
              
              # 添加变体到版本数据
              if variant != 'default':
                  version_data['label'] += f'-{variant}'
                  version_data['pubname'] += f'-{variant}'
              
              products[product_name]['versions'][version_id] = version_data
              
              if distro == 'debian' and version == '11':
                  print(f"Added Debian 11: {product_name}")
                  print(f"  Aliases: {aliases_string}")
                  print(f"  Version: {version_id}")
          
          current_time_str = current_time.strftime('%a, %d %b %Y %H:%M:%S +0000')
          
          # Ubuntu兼容的索引结构
          index_data = {
              'format': 'index:1.0',
              'index': {
                  'images': {
                      'datatype': 'image-downloads',
                      'path': 'streams/v1/images.json',
                      'updated': current_time_str,
                      'products': list(products.keys()),
                      'format': 'products:1.0'
                  }
              },
              'updated': current_time_str
          }
          
          # Ubuntu兼容的图像数据结构
          images_data = {
              'content_id': 'images',
              'datatype': 'image-downloads', 
              'format': 'products:1.0',
              'license': 'http://www.canonical.com/intellectual-property-policy',  # 添加许可证
              'products': products,
              'updated': current_time_str
          }
          
          os.makedirs('build/streams/v1', exist_ok=True)
          
          with open('build/streams/v1/index.json', 'w') as f:
              json.dump(index_data, f, indent=2, sort_keys=True)
              
          with open('build/streams/v1/images.json', 'w') as f:
              json.dump(images_data, f, indent=2, sort_keys=True)
          
          # _redirects文件
          with open('build/_redirects', 'w') as f:
              for rule in redirects_rules:
                  f.write(rule + '\n')
              f.write('/* /index.html 200\n')
          
          print(f"Generated {len(products)} products")
          
          # 详细调试
          print("\n=== Ubuntu兼容格式验证 ===")
          debian_count = 0
          for product_name, product in products.items():
              if 'debian:11' in product_name:
                  debian_count += 1
                  print(f"Product: {product_name}")
                  print(f"  Aliases: {product['aliases']}")
                  print(f"  Versions: {list(product['versions'].keys())}")
          
          print(f"Total Debian 11 products: {debian_count}")
          
          # 验证一个完整的debian产品
          sample_debian = None
          for name, data in products.items():
              if 'debian:11:amd64' in name and 'default' not in name:
                  sample_debian = (name, data)
                  break
          
          if sample_debian:
              name, data = sample_debian
              print(f"\n=== Sample Debian Product ===")
              print(f"Name: {name}")
              print(f"Data: {json.dumps(data, indent=2)[:500]}...")
          
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create HTML
        run: |
          cat > build/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>LXD Images - Ubuntu Compatible</title>
              <style>
                  body { font-family: Arial, sans-serif; padding: 20px; }
                  pre { background: #f0f0f0; padding: 15px; border-radius: 5px; }
                  .command { color: #0066cc; }
              </style>
          </head>
          <body>
              <h1>LXD Images Repository</h1>
              <p>Ubuntu-compatible SimpleStreams format</p>
              
              <h2>Setup</h2>
              <pre class="command">lxc remote add spiritlhl https://lxdimages.spiritlhl.net --protocol simplestreams --public</pre>
              
              <h2>Usage Examples</h2>
              <pre class="command">
          # List available images
          lxc image list spiritlhl:
          
          # Launch containers
          lxc launch spiritlhl:debian/11 my-debian
          lxc launch spiritlhl:ubuntu/22.04 my-ubuntu
          lxc launch spiritlhl:fedora/40 my-fedora
              </pre>
              
              <h2>API Endpoints</h2>
              <ul>
                  <li><a href="streams/v1/index.json">SimpleStreams Index</a></li>
                  <li><a href="streams/v1/images.json">Images Metadata</a></li>
              </ul>
          </body>
          </html>
          EOF
          
      - name: Create netlify.toml
        run: |
          cat > build/netlify.toml << 'EOF'
          [build]
            publish = "."
          
          [[headers]]
            for = "/streams/v1/*"
            [headers.values]
              Content-Type = "application/json; charset=utf-8"
              Cache-Control = "public, max-age=300"
              Access-Control-Allow-Origin = "*"
              Access-Control-Allow-Methods = "GET, HEAD"
          EOF

      - name: Deploy to Netlify  
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
